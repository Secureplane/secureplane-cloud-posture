import { LoggerService } from '../../../config/services/LoggerService';
import { ContainerImage, Vulnerability } from '../types/ContainerTypes';
import { WizApiClient } from '../../../api/client';

export class VulnerabilityScanner {
  private logger: LoggerService;
  private apiClient: WizApiClient;

  constructor(apiClient: WizApiClient) {
    this.logger = new LoggerService('VulnerabilityScanner');
    this.apiClient = apiClient;
  }

  async scan(image: ContainerImage): Promise<Vulnerability[]> {
    this.logger.info(`Scanning container image: ${image.name}:${image.tag}`);
    
    try {
      const scanResponse = await this.apiClient.scanResource({
        resourceId: `${image.name}:${image.tag}`,
        scanType: 'container',
        options: {
          includeVulnerabilities: true,
          includeMalware: true,
          includeSecrets: true,
          scanMode: 'agentless'
        }
      });

      return this.parseResults(scanResponse);
    } catch (error) {
      this.logger.error(`Vulnerability scan failed: ${error.message}`);
      throw error;
    }
  }

  private parseResults(results: any): Vulnerability[] {
    return results.findings
      .filter(finding => finding.type === 'vulnerability')
      .map(finding => ({
        id: finding.id,
        severity: this.normalizeSeverity(finding.severity),
        package: finding.affected.package,
        version: finding.affected.version,
        fixedVersion: finding.remediation?.version,
        description: finding.description,
        remediation: finding.remediation?.description,
        businessImpact: finding.businessImpact,
        attackVector: finding.attackVector,
        exploitability: finding.exploitability
      }));
  }

  private normalizeSeverity(severity: string): 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL' {
    const normalized = severity.toUpperCase();
    return ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'].includes(normalized) 
      ? normalized as 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL'
      : 'MEDIUM';
  }
}